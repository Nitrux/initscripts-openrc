#!/sbin/openrc-run

description="Check root filesystem and update mount points after root is mounted."

depend() {
    need localmount hostname
    before mountdevsubfs bootmisc
}

start_pre() {
    # Ensure /var/log/fsck is present for logging
    if [ ! -d /var/log/fsck ]; then
        mkdir -p /var/log/fsck
        chmod 755 /var/log/fsck
    fi

    # Activate swap devices before fsck
    ebegin "Activating swap devices"
    swapon -a -e
    eend $?
}

start() {
    ebegin "Checking root filesystem and updating mount points"

    local FSCK_LOGFILE="/var/log/fsck/checkroot"
    local FSCKFIX=${FSCKFIX:-no}
    local fsck_opts="-a"
    local fsck_result=0

    # Determine if we should force fsck
    if [ -f /forcefsck ] || grep -qw "forcefsck" /proc/cmdline; then
        fsck_opts="$fsck_opts -f"
    fi

    # Remount root as read-only before fsck
    ebegin "Remounting root filesystem as read-only"
    mount -o remount,ro /
    eend $?

    # Run fsck on the root filesystem
    ebegin "Running fsck on root filesystem"
    touch ${FSCK_LOGFILE}
    fsck $fsck_opts / >> ${FSCK_LOGFILE} 2>&1
    fsck_result=$?
    eend $fsck_result

    # Handle fsck exit codes
    if [ $fsck_result -eq 0 ]; then
        einfo "Filesystem clean"
    elif [ $fsck_result -eq 1 ]; then
        ewarn "Filesystem errors corrected"
    elif [ $fsck_result -gt 1 ]; then
        eerror "Filesystem errors uncorrected, entering maintenance mode"
        sulogin
    fi

    # Remount root as read-write
    ebegin "Remounting root filesystem as read-write"
    mount -o remount,rw /
    eend $?

    # Update mtab and related tasks
    update_mtab() {
        einfo "Updating mtab and reloading mounts"
        grep -v rootfs /proc/mounts > /etc/mtab
        if selinuxenabled; then
            restorecon /etc/mtab
        fi
        /etc/init.d/mountdevsubfs reload
        /etc/init.d/mountkernfs reload
    }
    update_mtab

    eend 0
}

stop() {
    # No stop action needed
    return 0
}

status() {
    # Check if root is writable and swap is active
    if grep " / " /proc/mounts | grep -q "rw,"; then
        einfo "Root filesystem is writable"
    else
        ewarn "Root filesystem is not writable"
    fi

    if swapon -s | grep -q "^"; then
        einfo "Swap is active"
    else
        ewarn "Swap is inactive"
    fi
}
